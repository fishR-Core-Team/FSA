---
title: "Fitting Growth Functions in FSA"
author: "Derek H. Ogle"
date: "`r Sys.Date()`"
format: 
  html: 
    toc: true
    toc-depth: 2
    reference-location: margin

knitr:
  opts_chunk:
    collapse: true
    comment: '#>'
    echo: true
    fig-width: 4.5
    fig-height: 4.5
    fig-align: center
---

```{r}
#| label: setup
#| results: hide
#| message: false
library(FSA)
library(ggplot2)
```

The objective of this article is to briefly describe how to fit growth functions commonly used in fisheries to data using the `FSA` package for R. It assumes that you are familiar with fish growth data, fish growth functions, and non-linear modeling. This background is also described in Chapter 12 of my [Introductory Fisheries Analyses with R](https://derekogle.com/IFAR/) book, my (and co-authors) Chapter 12 in [Age and Growth of Fishes: Principles and Techniques](https://fisheries.org/bookstore/all-titles/professional-and-trade/55078c/) book, and in several [fishR blog posts](https://fishr-core-team.github.io/fishR/blog/#category=Growth).

The main functions from `FSA` used to model fish growth are `makeGrowthFun()` to create R functions that represent various parameterizations of common fisheries growth functions, `findGrowthStarts()` to identify typically useful starting values to be used in non-linear algorithms for fitting common fisheries growth models, and `showGrowthFun()` for creating strings or expressions of the equations for common fisheries growth function. Each of these functions uses `type=` to identify a common fisheries growth function family (i.e,. `"von Bertalanffy"`, "`Gomperz`", "`logistic`", "`Richards`", "`Schnute`", or "`Schnute-Richards`") and `param=` or `pname=` to identify a specific paramaterization of the function within that family, either by number or by name. These and other common arguments to these functions are described and illustrated below. More focused or advanced use is illustrated in the function documentations.

# First Example -- Typical von Bertalanffy
The most common growth model is the von Bertalanffy model as parameterized by Beverton and Holt with three paramaters $L_\infty$, $K$, and $t_0$. The equation for this growth function can be displayed with `showGrowthFun()` using `type="von Bertalanffy"`, `pname="Typical"`,^[Or `param=1`] and, to display the equation, `plot=TRUE`).^[`cex=1.5` is used to make the text larger.]

```{r}
#| results: hide
#| fig-width: 3
#| fig-height: 1
showGrowthFun(type="von Bertalanffy",pname="Typical",plot=TRUE,cex=1.5)
```

An R function to return a predicted length from this equation when given an age (or ages) and values for the three parameters can be created with `makeGrowthFun()` using the same `type=` and `pname=`^[Or `param=`] as used in `showGrowthFun()`. The result from `makeGrowthFun()` should be assigned to an object, which will then be the name of the R function to predict lengths.

```{r}
vb1 <- makeGrowthFun(type="von Bertalanffy",pname="Typical")
```

For example, `vb1()` can now be used to predict the mean length for age-2 fish assuming $L_\infty=450$, $K=0.3$, and $t_0=-0.5$.

```{r}
vb1(2,Linf=450,K=0.3,t0=-0.5)
```

The default result from `makeGrowthFun()` creates a function where the three parameters can be given to the first parameter name as a numeric vector with values for all three parameters. For example, the mean length at age-2 can also be predicted with the following.


```{r}
vb1(2,Linf=c(450,0.3,-0.5))
```

Note that using the vector of parameter values in this way is useful (as will be demonstrated below) but also requires that the values are provided in the order that the function expects them. This order can be seen by displaying the function code and noting the order of the arguments in the function declaration.

```{r}
vb1
```

The same `vb1()` function can be used to predict mean lengths for a number of ages (e.g., ages 2 to 12 below).

```{r}
vb1(2:12,Linf=450,K=0.3,t0=-0.5)
```

These examples of predicted mean lengths at age given the growth function equation and parameter values are fairly trivial. The most useful aspect of the saved function will be its use in fitting data to the growth function.

Non-linear model fitting algorithms require starting values for the function parameters. Starting values for the parameters of most common fisheries growth functions can be obtained using `findGrowthStarts()`. To demonstrate `findGrowthStarts()` suppose that length-at-age (recorded as an annual age) are available in `tlV` and `age` of the `GrowthData1` data.frame,^[This data.frame is available in `FSA`.], a snapshot of which is shown below.

```{r}
peek(GrowthData1,n=10,which=c("tlV","age"))
```

`findGrowthStarts()` requires a formula of the form `length~age`,^[This is true for length-at-age models, but will differ for tag-recapture data, which will be shown later.] a corresponding data.frame in `data=`, and the same `type=` and `pname=`^[Or `param=`] as in `showGrowthFun()` and `makeGrowthFun()`. For example, starting values for the `GrowthData1` data and the typical parameterization of the von Bertalanffy growth function are obtained below. The results of `findGrowthStarts()` should be assigned to an object for later use.^[The leading and trailing parentheses below force the result to also be shown when it is assigned to an object.]

```{r}
( vsv1 <- findGrowthStarts(tlV~age,data=GrowthData1,type="von Bertalanffy",pname="Typical") )
```

There may be times when the provided starting values are non-sensical (you may get a warning message) or they do not lead to model convergence when fitting the non-linear regression to data. In these instances it may be useful to view a quick diagnostic plot of how the model evaluated at the starting values "fits" the data. Such a plot can be made by including `plot=TRUE` in `findGrowthStarts()`.^[As a general rule use `plot=TRUE` to immediately examine the relative "fit" of the starting values, rather than waiting for an "issue" to appear.]

```{r}
vsv1 <- findGrowthStarts(tlV~age,data=GrowthData1,type="von Bertalanffy",pname="Typical",
                         plot=TRUE)
```

Additionally, it may be useful to "fix" some starting values at values of your choice (rather than having them determined from the data). Such parameters can be included in a **NAMED** vector given to `fixed=` in `findGrowthStarts()`. For example, the `K` parameter is fixed at 0.5 below.^[Fixing $K$ looks inappropriate in this example.]

```{r}
vsv2 <- findGrowthStarts(tlV~age,data=GrowthData1,type="von Bertalanffy",param=1,
                         fixed=c(K=0.5),plot=TRUE)
```

Data are then fit to the non-linear growth model using `nls()` with a formula that has `length` on the left-hand-side and the specific growth function with the specific `age` variable and model parameter names on the right-hand-side, the associated data in `data=`, and the saved starting values in `start=`.

```{r}
resv1 <- nls(tlV~vb1(age,Linf,K,t0),data=GrowthData1,start=vsv1)
```

The estimated values of the parameters are extracted from this saved `nls()` object with `coef()` and likelihood profile confidence intervals are extracted with `confint()`. The two can be column-bound together for a concise report.

```{r}
cbind(Est=coef(resv1),confint(resv1))
```

Displaying the fitted function with the data can be done in a variety of ways. Below is a quick plot that uses `ggplot()` along with `stat_function()`. The important things to note about `stat_function()` are that the R function for the growth function is given in `fun=` and the parameter estimates are extracted with `coef()` and given to the first parameter name (i.e,. `Linf` in this example) inside a list that is assigned to `args=`.

```{r}
ggplot(data=GrowthData1,aes(y=tlV,x=age)) +
  geom_point(size=2.5,alpha=0.2) +
  scale_y_continuous(name="Total Length (mm)",limits=c(0,NA)) +
  scale_x_continuous(name="Age (years)") +
  stat_function(fun=vb1,args=list(Linf=coef(resv1)),linewidth=1.5,color="blue") +
  theme_bw()
```

An equation of the growth function with the parameter estimates can be created with `showGrowthFun()` using the same `type=` and `pname=` as before, but also including the saved `nls()` object in `fit=`. The object returned from `showGrowthFun()` can be used in `annotate()` from `ggplot2` to add the equation to the plot. Note that `parse=TRUE` is required in `annotate()` to convert the text returned from `showGrowthFun()` into an expression, `size=` controls the size of the text, and `x=` and `y=` are used to place (usually with trial-and-error) the equation.

```{r}
ggplot(data=GrowthData1,aes(y=tlV,x=age)) +
  geom_point(size=2.5,alpha=0.2) +
  scale_y_continuous(name="Total Length (mm)",limits=c(0,NA)) +
  scale_x_continuous(name="Age (years)") +
  stat_function(fun=vb1,args=list(Linf=coef(resv1)),linewidth=1.5,color="blue") +
  annotate(geom="text",
           label=showGrowthFun(type="von Bertalanffy",pame="Typical",fit=resv1),
           parse=TRUE,size=5,x=9,y=50) +
  theme_bw()
```

# Second Example -- Richards
The same general process works for other growth models. For example, suppose that your data suggests an inflection point in the growth trajectory so you want to fit the second parameterization of the Richards function, which has four parameters of $L_\infty$, $k$, $t_0$, and $b$. The same general workflow is illustrated below noting that `type="Richards"` and `param=2` is used, but those are assigned to objects outside the function to save some repetitive typing.^[Also note that the response variable was changed to `tlR` as these are lengths in `GrowthData1` that exhibited an inflection point.]

```{r}
typ <- "Richards"
prm <- 2
rich1 <- makeGrowthFun(type=typ,param=prm)
rsv1 <- findGrowthStarts(tlR~age,data=GrowthData1,type=typ,param=prm,plot=TRUE)
resr1 <- nls(tlR~rich1(age,Linf,k,t0,b),data=GrowthData1,start=rsv1)
cbind(Est=coef(resr1),confint(resr1))
```

```{r}
ggplot(data=GrowthData1,aes(y=tlR,x=age)) +
  geom_point(size=2.5,alpha=0.2) +
  scale_y_continuous(name="Total Length (mm)",limits=c(0,NA)) +
  scale_x_continuous(name="Age (years)") +
  stat_function(fun=rich1,args=list(Linf=coef(resr1)),linewidth=1.5,color="blue") +
  annotate(geom="text",label=showGrowthFun(type=typ,param=prm,fit=resr1),
           parse=TRUE,size=5,x=9,y=50) +
  theme_bw()
```

# Third Example -- Francis von Bertalanffy
Some growth models require certain values to be set at constant values. For example, the Francis parameterization of the von Bertalanffy function has three parameters ($L_1$, $L_2$, and $L_3$) that are estimated mean lengths at three specified ages. Two of those ages -- $t_1$ and $t_3$ -- are set by the user for defining $L_1$ and $L_3$. The third parameter ($L_2$) is defined at the time that is the average of $t_1$ and $t_3$. Ages for $t_1$ and $t_3$ must be set in a **NAMED** vector (`cv2` below) given to `constvals=` in `findGrowthStarts()`, the function created by `makeGrowthFun()`, and `showGrowthFun()`. The rest of the workflow is the same as above (noting that `type=` and `pname=` are adjusted).^[The result from `showGrowthFun()` was saved to an object here just to reduce clutter in the plotting code.]

```{r}
typ <- "von Bertalanffy"
prm <- "Francis"
vb2 <- makeGrowthFun(type=typ,pname=prm)
cv2 <- c(t1=0,t3=12)
rsv2 <- findGrowthStarts(tlV~age,data=GrowthData1,type=typ,pname=prm,
                         constvals=cv2,plot=TRUE)
resv2 <- nls(tlV~vb2(age,L1,L2,L3,t1=cv2),data=GrowthData1,start=rsv2)
cbind(Est=coef(resv2),confint(resv2))
```

```{r}
#| results: hide
eqn <- showGrowthFun(type=typ,pname=prm,fit=resv2,constvals=cv2)

ggplot(data=GrowthData1,aes(y=tlV,x=age)) +
  geom_point(size=2.5,alpha=0.2) +
  scale_y_continuous(name="Total Length (mm)",limits=c(0,NA)) +
  scale_x_continuous(name="Age (years)") +
  stat_function(fun=vb2,args=list(L1=coef(resv2),t1=cv2),linewidth=1.5,color="blue") +
  annotate(geom="text",label=eqn,parse=TRUE,size=3.5,x=8,y=50) +
  theme_bw()
```


# Fourth Example -- Somer's (Seasonal) von Bertalanffy
The Somer's parameterization of the von Bertalanffy can be used to model data where ages are fractional parts of the year, often referred to as seasonal length-at-age data. The process for fitting this model is very similar to above as illustrated below.^[Noting that the `tlS` from `GrowthData2` is used here as is contains a seasonal length-at-age example.]

```{r}
type <- "von Bertalanffy"
prm <- "Somers"
vb3 <- makeGrowthFun(type=typ,pname=prm)
rsv3 <- findGrowthStarts(tlS~age,data=GrowthData2,type=typ,pname=prm,plot=TRUE)
resv3 <- nls(tlS~vb3(age,Linf,K,t0,C,ts),data=GrowthData2,start=rsv3)
cbind(Est=coef(resv3),confint(resv3))
```

```{r}
#| results: hide
eqn <- showGrowthFun(type=typ,pname=prm,fit=resv3)

ggplot(data=GrowthData2,aes(y=tlS,x=age)) +
  geom_point(size=2.5,alpha=0.4) +
  scale_y_continuous(name="Total Length (mm)",limits=c(0,NA)) +
  scale_x_continuous(name="Age (years)") +
  stat_function(fun=vb3,args=list(Linf=coef(resv3)),linewidth=1.5,color="blue") +
  annotate(geom="text",label=eqn,parse=TRUE,size=2.5,x=3.5,y=50) +
  theme_bw()
```


# Fifth Example -- Fabens (Tag-Recapture) von Bertalanffy
Using parameterizations of the von Bertalanffy for tag-recapture data^[Generally, require observed lengths at marking, observed lengths at recapture or the change in observed length from marking, and the time-at-large (time difference between marking and recapture).] follows a similar workflow, but with a few different details. First, some of the parameterizations use the change in length as the response variable, whereas others use the length at recapture. Second, the primary explanatory variable in `FSA` is the time-at-large (time between marking and recapture) but the length at marking is also required. Thus, time-at-large will appear on the right-hand-side of the formulae used and the second argument in the function created by `makeGrowthFun()`. In addition, in 

```{r}
typ <- "von Bertalanffy"
prm <- "Fabens"
vb4 <- makeGrowthFun(type=typ,pname=prm)
rsv4 <- findGrowthStarts(deltaL~deltat+tlM,data=GrowthData3,type=typ,pname=prm)
resv4 <- nls(deltaL~vb4(deltat,tlM,Linf,K),data=GrowthData3,start=rsv4)
cbind(Est=coef(resv4),confint(resv4))
```


```{r}
#| results: hide
#| fig-width: 3
#| fig-height: 1
eqn <- showGrowthFun(type=typ,pname=prm,fit=resv4,plot=TRUE)
```

